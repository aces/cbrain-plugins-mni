
<%= form.params_hidden_field :collection_id %> <!-- can be nil -->

<fieldset>
<legend>Pipeline Options</legend>

  <%= form.params_label :template, "Template:", :title => "Define the template for image processing" %>
  <select name="<%= :template.model.to_la %>" id="<%= :template.to_la_id %>">
    <%= options_for_select(
          [ "0.50", "0.75", "1.00", "1.50", "2.00", "3.00", "4.00", "6.00" ],
          params[:template])
    %>
  </select>

  <br>

  <%= form.params_label :model, "Model:", :title => "Define the model for image-processing" %>
  <select name="<%= :model.to_la %>" id="<%= :model.to_la_id %>">
    <%= options_for_select(
          [ "icbm152lin", "icbm152nl" ],
          params[:model])
    %>
  </select>

  <% if ! @task.new_record? %>

    <br>

    <%= form.params_label :reset_from, "Restart from this stage:", :title => "Stage to restart from" %>
    <select name="<%= :reset_from.to_la %>" id="<%= :reset_from.to_la_id %>">
      <%= options_for_select(
            [ "" ] + CbrainTask::Civet::StagesNames,
            params[:reset_from])
      %>
    </select>
  <% end %>

</fieldset>

<P>

<fieldset>
<legend>CIVET options</legend>

  <%= form.params_label :interp, "Interpolation", :title => "Interpolation method from native to stereotaxic space (trilinear, tricubic, sinc) default trilinear" %>
  <select name="<%= :interp.to_la %>" id="<%= :interp.to_la_id %>">
  <%= options_for_select(
        [ "trilinear", "tricubic", "sinc" ],
        params[:interp])
  %>
  </select>

  <br>

  <%= form.params_label :N3_distance, "N3 distance:", :title => "N3 spline distance in mm (suggested values: 200 for 1.5T scan; 25 for 3T scan) default: 200" %>
  <%= form.params_text_field :N3_distance, :size => 4 %>

  <br>

  <%= form.params_label :lsq, "Number of parameters transformation for linear registration:", :title => "Number of parameters transformation for linear registration" %>
  <select name="<%= :lsq.to_la %>" id="<%= :lsq.to_la_id %>">
  <%= options_for_select(
        [ "6", "9", "12" ],
        params[:lsq])
  %>
  </select>

  <br>

  <%= form.params_label :no_surfaces, "Do NOT build surfaces:", :title => "Do NOT build surfaces" %>
  <%= form.params_check_box :no_surfaces %>

  <br>

  <%= form.params_label :thickness_method, "Thickness method:", :title => "Thickness method" %>
  <select name="<%= :thickness_method.to_la %>" id="<%= :thickness_method.to_la_id %>">
  <%= options_for_select(
        [ "tnormal", "tlink", "tlaplace", "tnear" ],
        params[:thickness_method])
  %>
  </select>
  <%= form.params_label :thickness_kernel, "and kernel size:", :title => "Kernel size" %>
  <%= form.params_text_field :thickness_kernel, :size => 4 %>

  <br>

  <%= form.params_label :resample_surfaces, "Resample surfaces:", :title => "Resample cortical surfaces" %>
  <%= form.params_check_box :resample_surfaces %>

  <br>

  <%= form.params_label :combine_surfaces, "Combine surfaces:", :title => "Combine left and right cortical surfaces" %>
  <%= form.params_check_box :combine_surfaces %>

</fieldset>

<P>

<fieldset>
<legend>VBM Options</legend>

  <%= form.params_label :VBM, "Process VBM files:", :title => "Process VBM files" %>
  <%= form.params_check_box :VBM %>

  <br>

  <%= form.params_label :VBM_fwhm, "Blurring kernel size in mm for volume:", :title => "Blurring kernel size in mm for volume" %>
  <%= form.params_text_field :VBM_fwhm, :size => 4 %>

  <br>

  <%= form.params_label :VBM_symmetry, "Run symmetry tools:", :title => "Run symmetry tools" %>
  <%= form.params_check_box :VBM_symmetry %>

  <br>

  <%= form.params_label :VBM_cerebellum, "Keep cerebellum in VBM maps:", :title => "Keep cerebellum in VBM maps" %>
  <%= form.params_check_box :VBM_cerebellum %>

</fieldset>

<P>

<fieldset>

<% if ! params[:collection_id].blank? %>
 <legend>MINC file input list for collection <em><%= Userfile.find(params[:collection_id]).name %></em></legend>
<% else %>
 <legend>MINC file input list</legend>
<% end %>

<table class="simple">
  <tr>
    <th>Launch CIVET?</th>
    <th>T1 name</th>
    <th>Prefix</th>
    <th>Subject ID</th>
    <th>T2 found?</th>
    <th>PD found?</th>
    <th>Mask found?</th>
    <th title="Use T1, T2 and PD native files for tissue classification">Use multispectral?</th>
    <th>Use mask?</th>
  </tr>
  <% 
    keys = params[:file_args].keys
    keys = keys.sort_by{ |k| params[:file_args][k][:t1_name] || ""}
   %>
  <% keys.each do |idx| %>
    <% file = params[:file_args][idx] %>
     <% if ! params[:collection_id].blank? %>
       <%= render :partial => 'tasks/cbrain_task/civet_file_from_col',  :locals  => {:file  => file, :idx => idx, :disabled => !@task.new_record? } %>
     <% else %>
       <%= render :partial => 'tasks/cbrain_task/civet_file_from_list', :locals  => {:file  => file, :idx => idx, :disabled => !@task.new_record? } %>
     <% end %>
  <% end %>
</table>

<P>

Convenience helper: provide overall patterns for
the <strong>prefix</strong> and <strong>subject ID</strong> here:

<P>

Prefix:     <%= form.params_text_field :prefix_auto_comp %>
Subject ID: <%= form.params_text_field :dsid_auto_comp %>

<P>

The patterns can include special <em>components</em>
<%= show_hide_toggle "(toggle explanation)", "#component_explain", :class  => 'action_link' %>
like <em>{1}</em>, <em>{2}</em> etc.

Click <%= submit_tag 'Refresh this list' %> to see all the Prefix and Subject IDs automatically updated.


<div id="component_explain" style="display:none">

Components identify the sequences of alphanumeric characters in the T1 filenames,
numbered from 1 to 8.
<p>
For instance, if a MINC T1 file is named "anonymous_2008-07-10_092900_10_mri.mnc", then its
componants would be:

      <ul>
        <li>{1} = "anonymous"</li>
        <li>{2} = "2008"</li>
        <li>{3} = "07"</li>
        <li>{4} = "10"</li>
        <li>{5} = "092900"</li>
        <li>{6} = "10"</li>
        <li>{7} = "mri"</li>
        <li>{8} = "mnc"</li>
      </ul>

As an example, if you entered the pattern "{1}_{6}" for the prefix,
then the actual prefix automatically extracted for you would be "anonymous_10".

</div>


</fieldset>


<% if @task.new_record? %>

<P>

<hr>

<BIG>Optional post-CIVET operations</BIG><P>

Combine CIVET results into a CivetStudy named: <%= form.params_text_field :study_name %> then <%= form.params_check_box :qc_study %> launch Claude's QC script on that CivetStudy.<br>

<% end %>




<% if current_user.has_role?(:admin) %>
 <hr>
 <BIG>Fake run:</BIG><P>
 Enter the numeric ID of a pre-existing CivetCollection to use it as 'pretend' output:
 <%= form.params_text_field :fake_run_civetcollection_id %>

<% end %>

