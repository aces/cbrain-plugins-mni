
<%

#
# CBRAIN Project
#
# $Id$
#

-%>

<% title 'Civet Parameters' %>

<h2>Launch CIVET tasks</h2>

<div class = "generalcontent">

   <div class = "generalbox">


      <% form_tag( '/tasks/create' ) do -%>

         <%= hidden_field_tag :task, 'DrmaaCivet' %>
         <%= hidden_field_tag 'bourreau_id',      default_args[:bourreau_id] %>
         <%= hidden_field_tag 'collection_id',    default_args[:collection_id] %> <!-- can be nil -->
         <%= hidden_field_tag 'file_ids[]',       default_args[:collection_id] || params[:file_ids] %> <!-- can NOT be nil (otherwise it messes with the redirect in case of error) -->
         
         <big>Description (optional)</big><BR>
         <%=  text_area_tag :description, nil, :cols  => 40 %><br><br>

         <big>Command options:</big><BR>

         <table class="userfiles">
            <tr>
               <th>Pipeline Control Options</th>
               <th>Civet Options</th>
            <tr>
            <tr class="list-even">
            <td>
               <table border="0" class="userfiles">
               <tr>
                  <td>
                     Make graph:
                  </td>
                  <td>
                    <%= check_box_tag( 'civet_args[make_graph]', '1', default_args[:civet_args][:make_graph]) %>     
                  </td>
               </tr>
               <tr>
                  <td>
                      Make filename graph:  
                  </td>
                  <td>
                      <%= check_box_tag( 'civet_args[make_filename_graph]', '1', default_args[:civet_args][:make_filename_graph] ) %>    
                  </td>
               </tr>
               <tr>
                  <td>
                      Print status report:
                  </td>
                  <td>
                      <%= check_box_tag( 'civet_args[print_status_report]', '1', default_args[:civet_args][:print_status_report] ) %>    
                  </td>
               </tr>
               </table>      
            </td>
            <td rowspan="3">
               <table border="0" class="userfiles">
                  <tr>
                     <td>
                        Interpolation:
                     </td>
                     <td>
                        <select name="civet_args[interp]">
                          <%= options_for_select(
                            [ "trilinear", "tricubic", "sinc" ],
                            default_args[:civet_args][:interp])
                          %>
                          </select>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        N3 distance:
                     </td>
                     <td>
                        <%= text_field_tag 'civet_args[N3_distance]', default_args[:civet_args][:N3_distance]   %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Number of parameters transformation for linear registration:
                     </td>
                     <td>
                        <select name="civet_args[lsq]">
                          <%= options_for_select(
                            [ "6", "9", "12" ],
                            default_args[:civet_args][:lsq])
                          %>
                          </select>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Do NOT build surfaces:
                     </td>
                     <td>
                         <%= check_box_tag( 'civet_args[no_surfaces]', '1', default_args[:civet_args][:no_surfaces] ) %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Thickness method and kernel size:       
                     </td>
                     <td>
                        <select name="civet_args[thickness_method]">
                          <%= options_for_select(
                            [ "tnormal", "tlink", "tlaplace", "tnear" ],
                            default_args[:civet_args][:thickness_method])
                          %>
                          </select>
                          <%= text_field_tag 'civet_args[thickness_kernel]', default_args[:civet_args][:thickness_kernel]   %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Resample surfaces:
                     </td>
                     <td>
                        <%= check_box_tag( 'civet_args[resample_surfaces]', '1', default_args[:civet_args][:resample_surfaces] ) %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Combine surfaces:
                     </td>
                     <td>
                        <%= check_box_tag( 'civet_args[combine_surfaces]', '1', default_args[:civet_args][:combine_surfaces] ) %>
                     </td>
                  </tr>
                </table>
            </td>
            </tr>

            <tr>
               <th>Pipeline Options</th>
            </tr>
            <tr class="list-even">
            <td>
               <table border="0" class="userfiles">
                  <tr>
                     <td>
                        Template:
                     </td>
                     <td>
                        <select name="civet_args[template]">
                          <%= options_for_select(
                            [ "0.50", "0.75", "1.00", "1.50", "2.00", "3.00", "4.00", "6.00" ],
                            default_args[:civet_args][:template])
                          %>
                          </select>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Model:
                     </td>
                     <td>
                        <select name="civet_args[model]">
                          <%= options_for_select(
                            [ "icbm152lin", "icbm152nl" ],
                            default_args[:civet_args][:model])
                          %>
                          </select>
                     </td>
                  </tr>
                </table>
            </td>
            </tr>


            <tr>
               <th COLSPAN="1">VBM Options</th>
               <th>(this space for rent)</th>
            </tr>

            <tr class="list-even">
            <td COLSPAN="1">
               <table border="0" class="userfiles">
                  <tr>
                     <td>
                        Process VBM files:
                     </td>
                     <td>
                        <%= check_box_tag( 'civet_args[VBM]', '1', default_args[:civet_args][:VBM] ) %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Blurring kernel size in mm for volume:
                     </td>
                     <td>
                        <%= text_field_tag 'civet_args[VBM_fwhm]', default_args[:civet_args][:VBM_fwhm], :size => 4 %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Run symmetry tools:
                     </td>
                     <td>
                        <%= check_box_tag( 'civet_args[VBM_symmetry]', '1', default_args[:civet_args][:VBM_symmetry] ) %>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Keep cerebellum in VBM maps:
                     </td>
                     <td>
                        <%= check_box_tag( 'civet_args[VBM_cerebellum]', '1', default_args[:civet_args][:VBM_cerebellum] ) %>
                     </td>
                  </tr>
               </table>
            </td>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(See your ad here!)</td>
            </tr>

         </table>

         <br>

         Save results to:
         <%= data_provider_select "data_provider_id", params[:data_provider_id], { :include_blank => "Data provider of input files" } %><br><br>

         Save selections as defaults: <%= check_box_tag( :save_as_defaults, '1') %><br><br>

         <%= submit_tag 'Start CIVET' %>

         <hr>

         <% if default_args[:collection_id] %>
           <big>MINC file input list for collection <em><%= Userfile.find(default_args[:collection_id]).name %></em></big>
         <% else %>
           <big>MINC file input list</big>
         <% end %>
         <br>
         <table class="civet_options">
            <tr>
              <th>Launch CIVET?</th>
              <th>T1 name</th>
              <th>Prefix</th>
              <th>Subject ID</th>
              <th>T2 found?</th>
              <th>PD found?</th>
              <th>Mask found?</th>
              <th>Use multispectral?</th>
              <th>Use mask?</th>
            </tr>
            <% default_args[:file_args].each_with_index do |file,idx| %>
               <% if default_args[:collection_id] %>
                 <%= render :partial => 'civet_file_from_col',  :locals  => {:file  => file, :idx => idx } %>
               <% else %>
                 <%= render :partial => 'civet_file_from_list', :locals  => {:file  => file, :idx => idx } %>
               <% end %>
            <% end %>
         </table>

         <%= submit_tag 'Start CIVET' %>

         <hr>

         <BIG>Optional post-Civet operations</BIG><P>

         Combine CIVET results into a CivetStudy named: <%= text_field_tag "study_name" %> then <%= check_box_tag "qc_study", 1 %> launch Claude's QC script on that CivetStudy.<br>

         <%= submit_tag 'Start CIVET' %>

         <% if current_user.has_role?(:admin) %>
           <hr>
           <BIG>Fake run:</BIG><P>
           Enter the numeric ID of a pre-existing CivetCollection to use it as 'pretend' output:
           <%= text_field_tag "fake_run_civetcollection_id" %>
           <P>
           <%= submit_tag 'Start CIVET' %>
         <% end %>

      <% end %>  <!-- End form -->

   </div>  <!-- End class="generalbox" -->
</div>   <!-- End class="generalcontent" -->
